<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PIZARR√ìN EPEM‚Äî Tablero Colaborativo</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --border: #1e1e2e;
    --accent: #00ff88;
    --accent2: #ff4466;
    --accent3: #4488ff;
    --text: #e8e8f0;
    --muted: #555570;
    --card: #16161f;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    overflow: hidden;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .sidebar {
    position: fixed;
    top: 0; left: 0; bottom: 0;
    width: 56px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 0;
    gap: 4px;
    z-index: 1001;
  }
  .sidebar-btn {
    width: 44px; height: 44px;
    border: none;
    border-radius: 8px;
    background: transparent;
    color: var(--muted);
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: all 0.15s;
  }
  .sidebar-btn:hover { background: var(--border); color: var(--text); }
  .sidebar-btn.active { background: rgba(0,255,136,0.12); color: var(--accent); border: 1px solid rgba(0,255,136,0.3); }
  .sidebar-btn .badge {
    position: absolute;
    top: 2px; right: 2px;
    min-width: 16px; height: 16px;
    padding: 0 4px;
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    background: var(--accent2);
    color: var(--bg);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .sidebar-btn[title] { cursor: help; }

  .topbar {
    position: fixed;
    top: 0; left: 56px; right: 0;
    height: 52px;
    background: rgba(10,10,15,0.95);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 14px;
    z-index: 1000;
    backdrop-filter: blur(12px);
  }

  .logo {
    font-size: 18px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--accent);
    text-transform: uppercase;
    flex-shrink: 0;
  }
  .logo span { color: var(--text); }

  .session-id {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: #c4c4dc;
    border: 1px solid var(--border);
    padding: 3px 8px;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .days-badge {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    border: 1px solid rgba(0,255,136,0.3);
    background: rgba(0,255,136,0.05);
    padding: 3px 10px;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .users-count {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: #c4c4dc;
    flex-shrink: 0;
  }
  .users-count strong { color: var(--text); }

  .username-display {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: #c4c4dc;
    padding: 3px 8px;
    border-radius: 4px;
    border: 1px solid transparent;
    cursor: pointer;
    max-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .username-display:hover { border-color: var(--border); color: var(--text); }
  .username-display::before { content: 'üë§ '; }

  .spacer { flex: 1; }

  .btn {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    padding: 6px 14px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex-shrink: 0;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 700; }
  .btn.primary:hover { background: #00cc6f; }

  .canvas {
    position: fixed;
    top: 52px; left: 56px; right: 0; bottom: 0;
    overflow: auto;
    z-index: 1;
  }
  .canvas-inner {
    position: relative;
    width: 100%;
    min-height: 100%;
    box-sizing: border-box;
    padding: 16px;
  }

  .drop-overlay {
    position: fixed;
    top: 52px; left: 56px; right: 0; bottom: 0;
    border: 3px dashed var(--accent);
    background: rgba(0,255,136,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .drop-overlay.active { opacity: 1; }
  .drop-overlay-text {
    font-size: 32px;
    font-weight: 800;
    color: var(--accent);
    text-align: center;
    letter-spacing: -1px;
  }

  .card {
    position: absolute;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    min-width: 240px;
    max-width: 420px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    cursor: grab;
    user-select: none;
    transition: box-shadow 0.15s, border-color 0.15s;
    animation: card-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes card-in {
    from { opacity: 0; transform: scale(0.85) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }
  .card:hover { box-shadow: 0 12px 48px rgba(0,0,0,0.6); }
  .card.dragging { cursor: grabbing; box-shadow: 0 24px 64px rgba(0,0,0,0.8); border-color: var(--accent); z-index: 500; }
  .card.card-pulse {
    animation: card-pulse 0.6s ease-in-out 3;
  }
  @keyframes card-pulse {
    0%, 100% { box-shadow: 0 8px 32px rgba(0,0,0,0.4); border-color: var(--border); }
    50% { box-shadow: 0 0 0 3px var(--accent), 0 0 24px rgba(0,255,136,0.4); border-color: var(--accent); }
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px 8px;
    border-bottom: 1px solid var(--border);
  }
  .card-lang {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .lang-sql  { background: rgba(68,136,255,0.15); color: var(--accent3); border: 1px solid rgba(68,136,255,0.3); }
  .lang-jsx  { background: rgba(0,255,136,0.1); color: var(--accent); border: 1px solid rgba(0,255,136,0.2); }
  .lang-js   { background: rgba(255,220,0,0.1); color: #ffdc00; border: 1px solid rgba(255,220,0,0.2); }
  .lang-json { background: rgba(255,150,50,0.1); color: #ff9632; border: 1px solid rgba(255,150,50,0.2); }
  .lang-py   { background: rgba(100,180,255,0.1); color: #64b4ff; border: 1px solid rgba(100,180,255,0.2); }
  .lang-css  { background: rgba(200,100,255,0.1); color: #c864ff; border: 1px solid rgba(200,100,255,0.2); }
  .lang-txt  { background: rgba(100,100,120,0.2); color: var(--muted); border: 1px solid var(--border); }
  .lang-file { background: rgba(255,68,102,0.1); color: var(--accent2); border: 1px solid rgba(255,68,102,0.2); }

  .card-filename {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .card-actions { display: flex; gap: 4px; }
  .card-btn {
    width: 22px; height: 22px;
    border-radius: 3px;
    border: none;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    font-size: 12px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.1s;
  }
  .card-btn:hover { background: var(--border); color: var(--text); }
  .card-btn.danger:hover { background: rgba(255,68,102,0.2); color: var(--accent2); }

  .card-body {
    padding: 12px;
    max-height: 280px;
    overflow-y: auto;
    overflow-x: hidden;
  }
  .card-body::-webkit-scrollbar { width: 4px; }
  .card-body::-webkit-scrollbar-track { background: transparent; }
  .card-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  pre {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    line-height: 1.7;
    color: #b0b0cc;
    white-space: pre-wrap;
    word-break: break-all;
  }
  .card-footer {
    padding: 6px 12px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-time {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    flex: 1;
  }
  .card-download {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--accent);
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 3px;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .card-download:hover { color: #00cc6f; }

  .file-icon { font-size: 32px; display: block; margin-bottom: 8px; }
  .file-meta { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); line-height: 1.6; }

  .kw  { color: #ff79c6; }
  .str { color: var(--accent); }
  .cmt { color: var(--muted); font-style: italic; }
  .num { color: #bd93f9; }

  .paste-hint {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 8px 20px;
    border-radius: 20px;
    background: var(--surface);
    z-index: 900;
    pointer-events: none;
    animation: float 3s ease-in-out infinite;
  }
  @keyframes float {
    0%, 100% { transform: translateX(-50%) translateY(0); }
    50%       { transform: translateX(-50%) translateY(-4px); }
  }

  .toast {
    position: fixed;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface);
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    padding: 8px 20px;
    border-radius: 6px;
    z-index: 2000;
    opacity: 0;
    transition: all 0.25s;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .new-card-btn {
    position: fixed;
    bottom: 24px;
    right: 160px;
    width: 44px; height: 44px;
    border-radius: 50%;
    background: var(--accent);
    color: var(--bg);
    border: none;
    font-size: 22px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 20px rgba(0,255,136,0.3);
    z-index: 900;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .new-card-btn:hover { transform: scale(1.1); box-shadow: 0 6px 28px rgba(0,255,136,0.5); }

  /* ============ PIXEL BUG PET ============ */
  .pet-container {
    position: fixed;
    bottom: 0;
    right: 12px;
    width: 130px;
    z-index: 950;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-bottom: 2px;
    pointer-events: none;
  }

  .pet-label {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: var(--muted);
    text-align: center;
    margin-bottom: 1px;
    letter-spacing: 0.5px;
  }
  .pet-label .pet-name { color: var(--accent); font-weight: 700; }
  .pet-label .pet-lv { color: #ffdc00; }

  canvas#bugCanvas {
    image-rendering: pixelated;
    image-rendering: crisp-edges;
    display: block;
  }

  /* grow animation popup */
  .grow-pop {
    position: fixed;
    right: 80px;
    bottom: 90px;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    color: var(--accent);
    pointer-events: none;
    z-index: 960;
    animation: pop-up 1.4s ease-out forwards;
    text-shadow: 0 0 8px rgba(0,255,136,0.8);
  }
  @keyframes pop-up {
    0%   { opacity: 0; transform: translateY(0) scale(0.7); }
    20%  { opacity: 1; transform: translateY(-6px) scale(1.1); }
    80%  { opacity: 1; transform: translateY(-20px) scale(1); }
    100% { opacity: 0; transform: translateY(-30px) scale(0.9); }
  }

  /* Celebration confetti */
  .celebration-confetti {
    position: fixed;
    left: 50%;
    top: 50%;
    width: 6px;
    height: 6px;
    border-radius: 1px;
    pointer-events: none;
    z-index: 3000;
    animation: confetti-fly 1.2s ease-out forwards;
  }
  @keyframes confetti-fly {
    0% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1) rotate(0deg);
    }
    100% {
      opacity: 0;
      transform: translate(
        calc(-50% + var(--dx, 0px)),
        calc(-50% + var(--dy, -120px))
      ) scale(0.3) rotate(720deg);
    }
  }

  /* Zzz sleep text */
  .pet-zzz {
    position: absolute;
    left: 50%;
    top: -8px;
    transform: translateX(-50%);
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
    animation: zzz-float 1.5s ease-in-out infinite;
    pointer-events: none;
  }
  @keyframes zzz-float {
    0%, 100% { opacity: 0.6; transform: translateX(-50%) translateY(0); }
    50% { opacity: 1; transform: translateX(-50%) translateY(-4px); }
  }

  /* Manual / ayuda ‚Äî esquina inferior izquierda */
  .manual-btn {
    position: fixed;
    bottom: 24px;
    left: 72px;
    width: 44px;
    height: 44px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 900;
    transition: all 0.15s;
  }
  .manual-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,255,136,0.06);
  }

  .manual-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 2500;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
  }
  .manual-overlay.open {
    opacity: 1;
    visibility: visible;
  }
  .manual-panel {
    position: relative;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    max-width: 420px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 24px 64px rgba(0,0,0,0.5);
    transform: scale(0.95);
    transition: transform 0.2s;
  }
  .manual-overlay.open .manual-panel {
    transform: scale(1);
  }
  .manual-panel h2 {
    font-size: 18px;
    color: var(--accent);
    padding: 20px 48px 8px 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
  }
  .manual-panel .manual-body {
    padding: 20px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    line-height: 1.7;
    color: var(--text);
  }
  .manual-panel .manual-body p {
    margin-bottom: 14px;
  }
  .manual-panel .manual-body p:last-child { margin-bottom: 0; }
  .manual-panel .manual-body strong { color: var(--accent); }
  .manual-panel .manual-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    background: transparent;
    color: var(--muted);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .manual-panel .manual-close:hover {
    background: var(--border);
    color: var(--text);
  }
  .manual-panel-wrapper { position: relative; }
  .manual-mascota {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    color: var(--muted);
  }
  .manual-mascota .pet-name-ref { color: var(--accent); font-weight: 700; }
</style>
</head>
<body>

<!-- SIDEBAR DEPARTAMENTOS -->
<nav class="sidebar" id="sidebar">
  <button class="sidebar-btn active" id="space-general" data-space="general" title="General" onclick="switchSpace('general')">üìã</button>
  <button class="sidebar-btn" id="space-soporte" data-space="soporte" title="Soporte" onclick="switchSpace('soporte')">üéß</button>
  <button class="sidebar-btn" id="space-desarrollo" data-space="desarrollo" title="Desarrollo" onclick="switchSpace('desarrollo')">üíª</button>
  <button class="sidebar-btn" id="space-procesos" data-space="procesos" title="Procesos" onclick="switchSpace('procesos')">üîÑ</button>
  <button class="sidebar-btn" id="space-infra" data-space="infra" title="Infraestructura" onclick="switchSpace('infra')">üñ•Ô∏è</button>
  <button class="sidebar-btn" id="space-bi" data-space="bi" title="BI" onclick="switchSpace('bi')">üìä</button>
</nav>

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo">Pizarr√≥n Grupo Epem</div>
  <span class="session-id" id="spaceLabel" style="max-width:140px;overflow:hidden;text-overflow:ellipsis;">General</span>
  <div class="session-id" id="sessionId">SES-XXXXXX</div>
  <div class="days-badge" id="daysBadge">üìÖ d√≠a 1</div>
  <div class="users-count" title="Quien ha abierto este enlace en este navegador (sin servidor no hay lista en vivo)">üë• <strong id="userCount">1</strong> en sesi√≥n</div>
  <span class="username-display" id="usernameDisplay" title="Clic para cambiar nombre">An√≥nimo</span>
  <div class="spacer"></div>
  <button class="btn" onclick="organizeCardsInGrid()">Organizar</button>
  <button class="btn" onclick="clearAll()">Limpiar</button>
  <button class="btn" id="restoreBtn" onclick="restoreCleared()" style="display:none;">‚Ü© Restaurar</button>
  <button class="btn primary" onclick="shareSession()">üîó Compartir</button>
</div>

<!-- CANVAS -->
<div class="canvas" id="canvas">
  <div class="canvas-inner" id="canvasInner"></div>
</div>

<!-- DROP OVERLAY -->
<div class="drop-overlay" id="dropOverlay">
  <div class="drop-overlay-text">
    SOLTAR ARCHIVO<br>
    <span style="font-size:16px; color: var(--muted); font-weight:400">Se detectar√° el tipo autom√°ticamente</span>
  </div>
</div>

<!-- PASTE HINT -->
<div class="paste-hint">‚åòV para pegar c√≥digo ‚Äî arrastra archivos al tablero</div>

<!-- MANUAL (esquina inferior izquierda) -->
<button class="manual-btn" onclick="openManual()" title="¬øC√≥mo funciona?">üìñ</button>
<div class="manual-overlay" id="manualOverlay" onclick="closeManualIfBackdrop(event)">
  <div class="manual-panel-wrapper" onclick="event.stopPropagation()">
    <div class="manual-panel">
      <button class="manual-close" onclick="closeManual()" title="Cerrar">‚úï</button>
      <h2>Bienvenido al Pizarr√≥n</h2>
      <div class="manual-body" id="manualBody">
        <p>Hola, <strong id="manualUserName">Usuario</strong>.</p>
        <p>Este es el <strong>Pizarr√≥n Grupo EPEM</strong>: un tablero colaborativo para compartir c√≥digo y archivos por departamento.</p>
        <p><strong>¬øC√≥mo usarlo?</strong> Usa la barra lateral para cambiar de espacio (General, Soporte, Desarrollo, etc.). Pega c√≥digo con <strong>Ctrl+V</strong> o arrastra archivos al tablero. El bot√≥n <strong>+</strong> abre el explorador para agregar m√°s. Puedes mover las tarjetas arrastr√°ndolas, descargar con ¬´‚Üì descargar¬ª y organizar con el bot√≥n <strong>Organizar</strong>. Las tarjetas se guardan en este navegador al recargar. Comparte el enlace con <strong>Compartir</strong> para que otros abran la misma sesi√≥n (cada uno ve sus propias tarjetas hasta que haya un servidor en tiempo real).</p>
        <p><strong>Tip:</strong> El color del tablero cambia seg√∫n el lenguaje m√°s usado. Si pegar no funciona, usa el bot√≥n +.</p>
        <div class="manual-mascota">
          <p><strong>Nuestra mascota</strong> es <span class="pet-name-ref">GUSSI</span>: un bichito pixelado que vive en la esquina del pizarr√≥n. Sube de nivel cuando compartes contenido (una vez por d√≠a), reacciona cuando pegas c√≥digo, se duerme si no hay actividad y celebra cuando descargas algo. ¬°Cu√≠dala!</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADD BUTTON -->
<input type="file" id="fileInput" multiple accept="*/*" style="display:none">
<button class="new-card-btn" onclick="openFilePicker()" title="Agregar archivos o c√≥digo">+</button>

<!-- PIXEL BUG PET -->
<div class="pet-container">
  <div class="pet-label">
    <span class="pet-name">GUSSI</span> ¬∑ <span class="pet-lv" id="petLvLabel">lv.1</span>
  </div>
  <div class="pet-zzz" id="petZzz" style="visibility:hidden;">Z z z</div>
  <canvas id="bugCanvas" width="100" height="90"></canvas>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ========== SESSION (persistent via localStorage + URL) ==========
function getOrCreateSession() {
  const urlParams = new URLSearchParams(window.location.search);
  const urlSes = urlParams.get('session');

  if (urlSes) {
    let stored = JSON.parse(localStorage.getItem('pz_' + urlSes) || 'null');
    if (!stored) {
      stored = { id: urlSes, createdAt: Date.now(), users: 0 };
    }
    stored.users = (stored.users || 0) + 1;
    localStorage.setItem('pz_' + urlSes, JSON.stringify(stored));
    return { ...stored, isJoining: true };
  }

  const curKey = localStorage.getItem('pz_current');
  if (curKey) {
    const stored = JSON.parse(localStorage.getItem('pz_' + curKey) || 'null');
    if (stored) return stored;
  }

  const id = 'SES-' + Math.random().toString(36).substr(2, 6).toUpperCase();
  const data = { id, createdAt: Date.now(), users: 1 };
  localStorage.setItem('pz_' + id, JSON.stringify(data));
  localStorage.setItem('pz_current', id);
  return data;
}

const session = getOrCreateSession();
const SESSION_ID    = session.id;
const SESSION_START = session.createdAt;
let   totalUsers    = session.users;

document.getElementById('sessionId').textContent = SESSION_ID;

// ========== ESPACIOS / DEPARTAMENTOS ==========
const SPACES = {
  general: 'General',
  soporte: 'Soporte',
  desarrollo: 'Desarrollo',
  procesos: 'Procesos',
  infra: 'Infraestructura',
  bi: 'BI'
};
let currentSpace = (function() {
  const p = new URLSearchParams(window.location.search).get('space');
  return (p && SPACES[p]) ? p : 'general';
})();

var clearedCardsBuffer = {};
function initClearedBuffer() {
  Object.keys(SPACES).forEach(s => { clearedCardsBuffer[s] = []; });
}
initClearedBuffer();

function updateRestoreButtonVisibility() {
  const btn = document.getElementById('restoreBtn');
  const n = (clearedCardsBuffer[currentSpace] || []).length;
  btn.style.display = n > 0 ? '' : 'none';
}

function switchSpace(space) {
  if (!SPACES[space]) return;
  currentSpace = space;
  const url = new URL(window.location.href);
  url.searchParams.set('space', space);
  window.history.replaceState({}, '', url);
  document.querySelectorAll('.sidebar-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.space === space);
  });
  document.getElementById('spaceLabel').textContent = SPACES[space];
  refreshSpaceVisibility();
  updateSpaceBadges();
  updateAccentFromBoard();
  updateRestoreButtonVisibility();
}

function refreshSpaceVisibility() {
  document.querySelectorAll('.card').forEach(el => {
    el.style.display = el.dataset.space === currentSpace ? '' : 'none';
  });
}

function updateSpaceBadges() {
  const counts = {};
  Object.keys(SPACES).forEach(s => { counts[s] = 0; });
  Object.keys(cards).forEach(id => {
    const s = cards[id].space || 'general';
    if (counts[s] !== undefined) counts[s]++;
  });
  document.querySelectorAll('.sidebar-btn').forEach(btn => {
    const s = btn.dataset.space;
    const n = counts[s] || 0;
    let bad = btn.querySelector('.badge');
    if (n > 0) {
      if (!bad) { bad = document.createElement('span'); bad.className = 'badge'; btn.appendChild(bad); }
      bad.textContent = n > 99 ? '99+' : n;
    } else if (bad) bad.remove();
  });
}

// ========== NOMBRE DE USUARIO ==========
const USERNAME_KEY = 'pz_username';
function getOrPromptUsername() {
  let name = (localStorage.getItem(USERNAME_KEY) || '').trim();
  if (!name) {
    name = (prompt('¬øTu nombre? (aparecer√° en lo que subas al pizarr√≥n)') || 'An√≥nimo').trim().slice(0, 40) || 'An√≥nimo';
    localStorage.setItem(USERNAME_KEY, name);
    updateUsernameDisplay();
  }
  return name || 'An√≥nimo';
}
function setUsername(newName) {
  const n = (newName || '').trim().slice(0, 40) || 'An√≥nimo';
  localStorage.setItem(USERNAME_KEY, n);
  updateUsernameDisplay();
}
function updateUsernameDisplay() {
  const el = document.getElementById('usernameDisplay');
  if (el) el.textContent = (localStorage.getItem(USERNAME_KEY) || 'An√≥nimo').trim() || 'An√≥nimo';
}
updateUsernameDisplay();
document.getElementById('usernameDisplay').addEventListener('click', function() {
  const name = prompt('Tu nombre:', localStorage.getItem(USERNAME_KEY) || '');
  if (name !== null) setUsername(name);
});

// Days counter (never expires)
function updateDays() {
  const days = Math.max(1, Math.floor((Date.now() - SESSION_START) / 86400000) + 1);
  document.getElementById('daysBadge').textContent = `üìÖ d√≠a ${days}`;
}
updateDays();

function updateUserCount() {
  document.getElementById('userCount').textContent = totalUsers;
}
updateUserCount();

// ========== PIXEL BUG PET ==========
const BC = document.getElementById('bugCanvas');
const bx = BC.getContext('2d');
bx.imageSmoothingEnabled = false;

// Pet state ‚Äî level grows 1 vez por d√≠a solo al compartir archivos/c√≥digo
const GUSSI_STORAGE_KEY = 'pz_gussi_' + SESSION_ID;
function loadPetState() {
  try {
    const raw = localStorage.getItem(GUSSI_STORAGE_KEY);
    if (raw) {
      const data = JSON.parse(raw);
      return { level: Math.min(10, Math.max(1, data.level || 1)), lastLevelUpDate: data.lastLevelUpDate || '' };
    }
  } catch (e) {}
  return { level: 1, lastLevelUpDate: '' };
}
function savePetState(level, lastLevelUpDate) {
  localStorage.setItem(GUSSI_STORAGE_KEY, JSON.stringify({ level, lastLevelUpDate }));
}
const petState = loadPetState();
let petLevel = petState.level;
let petMood  = 0;   // 0-1, decays
let petFrame = 0;
let petWalkX = 0;
let petDir   = 1;
let lastTick = 0;
let petJump  = 0;   // frames remaining for jump bounce
let petSleeping = false;
const INACTIVITY_MS = 22000;  // dormir despu√©s de 22s sin actividad
let lastActivityTime = Date.now();

const P  = 5; // one pixel block = 5px
const CW = BC.width;
const CH = BC.height;

// Color palette
const COL = {
  b1: '#22dd66',  // body main
  b2: '#119944',  // body alt
  b3: '#55ff99',  // highlight
  leg:'#0d8833',
  eye:'#ffffff',
  pup:'#001a00',
  ant:'#00ff88',
  wng:'rgba(0,255,136,0.2)',
  crw:'#ffcc00',
  glo:'rgba(0,255,136,0.12)',
};

function fp(x, y, w, h, color) {
  bx.fillStyle = color;
  bx.fillRect(Math.round(x), Math.round(y), Math.round(w), Math.round(h));
}

function drawBug(lv, frame, mood) {
  bx.clearRect(0, 0, CW, CH);

  const segs    = Math.min(1 + Math.floor(lv / 2), 6);   // 1-6 segments
  const hasAnt  = lv >= 2;
  const twoEyes = lv >= 5;
  const hasWing = lv >= 8;
  const hasCrwn = lv >= 10;

  // total body width in pixels: head(2P) + segs(2P each)
  const totalW = (segs * 2 + 2) * P;
  const baseX  = Math.floor((CW - totalW) / 2) + petWalkX;
  const groundY = CH - P * 2;    // bottom ground line Y

  // body top Y
  const bodyY = groundY - P * 2;
  const headY = groundY - P * 3;

  // jump offset (par√°bola: m√°ximo al inicio, 0 al final)
  const jumpFrames = 18;
  let jumpOffset = 0;
  if (petJump > 0) {
    const t = 1 - petJump / jumpFrames;
    jumpOffset = Math.max(0, 12 * Math.sin(t * Math.PI));
  }
  if (jumpOffset > 0) {
    bx.save();
    bx.translate(0, -jumpOffset);
  }

  // glow when mood > 0
  if (mood > 0.2) {
    bx.save();
    bx.shadowColor = '#00ff88';
    bx.shadowBlur  = 16 * mood;
  }

  // wings (drawn behind body)
  if (hasWing) {
    bx.save();
    bx.globalAlpha = 0.22 + Math.sin(frame * 0.4) * 0.08;
    const wX = baseX + segs * P;
    const wY = bodyY - P;
    bx.fillStyle = '#00ff88';
    bx.beginPath();
    bx.ellipse(wX - P*3, wY, P*4, P*2, -0.35, 0, Math.PI*2);
    bx.fill();
    bx.beginPath();
    bx.ellipse(wX + P*3 + P*2, wY, P*4, P*2, 0.35, 0, Math.PI*2);
    bx.fill();
    bx.restore();
  }

  // segments
  for (let s = 0; s < segs; s++) {
    const sx  = baseX + s * P * 2;
    const alt = s % 2 === 0;
    // main block
    fp(sx, bodyY, P*2, P*2, alt ? COL.b1 : COL.b2);
    // top highlight
    bx.globalAlpha = 0.35;
    fp(sx, bodyY, P*2, P, COL.b3);
    bx.globalAlpha = 1;
    // legs (walk offset every other frame)
    const lOff = (frame % 2 === 0 && alt) ? P*0.4 : 0;
    fp(sx - P,        groundY - P + lOff, P,   P*1.4, COL.leg);
    fp(sx + P*2,      groundY - P - lOff, P,   P*1.4, COL.leg);
  }

  // head block
  const hX = baseX + segs * P * 2;
  fp(hX, headY, P*2, P*3, COL.b1);
  // head highlight
  bx.globalAlpha = 0.4;
  fp(hX, headY, P*2, P, COL.b3);
  bx.globalAlpha = 1;

  // eyes (cerrados si duerme)
  const eyeSlots = twoEyes ? [0, P] : [P * 0.5];
  if (petSleeping) {
    eyeSlots.forEach(ey => {
      const ex = hX + P*0.4, eyY = headY + P*0.5 + ey;
      bx.strokeStyle = COL.pup;
      bx.lineWidth = 1.5;
      bx.beginPath();
      bx.moveTo(ex, eyY + P*0.5);
      bx.lineTo(ex + P, eyY + P*0.5);
      bx.stroke();
    });
  } else {
    eyeSlots.forEach(ey => {
      fp(hX + P*0.4, headY + P*0.5 + ey, P, P, COL.eye);
      const pupOff = petDir > 0 ? P*0.5 : 0;
      fp(hX + P*0.4 + pupOff, headY + P*0.5 + ey, P*0.5, P*0.5, COL.pup);
    });
  }

  // antennae
  if (hasAnt) {
    fp(hX,          headY - P,     P*0.5, P,     COL.ant);
    fp(hX - P*0.5,  headY - P*2,   P*0.5, P*0.5, COL.ant);
    fp(hX + P,      headY - P,     P*0.5, P,     COL.ant);
    fp(hX + P*1.5,  headY - P*2,   P*0.5, P*0.5, COL.ant);
  }

  // crown
  if (hasCrwn) {
    fp(hX,          headY - P*3,   P*0.5, P,     COL.crw);
    fp(hX + P*0.5,  headY - P*4,   P,     P*0.5, COL.crw);
    fp(hX + P*1.5,  headY - P*3,   P*0.5, P,     COL.crw);
  }

  // mood sparkles
  if (mood > 0.4) {
    bx.globalAlpha = mood;
    const sp1x = hX + P*3 + Math.sin(frame * 0.6) * P;
    const sp1y = headY - Math.cos(frame * 0.8) * P*2;
    fp(sp1x, sp1y, P*0.5, P*0.5, COL.ant);
    const sp2x = hX - P*2 + Math.sin(frame * 0.9 + 1) * P;
    const sp2y = headY + P - Math.cos(frame * 0.5 + 2) * P*2;
    fp(sp2x, sp2y, P*0.5, P*0.5, COL.ant);
    bx.globalAlpha = 1;
  }

  if (mood > 0.2) bx.restore();
  if (jumpOffset > 0) bx.restore();
}

function tickBug(ts) {
  if (ts - lastTick > 180) {  // ~5.5 fps, chunky pixel feel
    petFrame++;
    lastTick = ts;

    if (petJump > 0) petJump--;

    petSleeping = (Date.now() - lastActivityTime > INACTIVITY_MS);
    const zzzEl = document.getElementById('petZzz');
    if (zzzEl) zzzEl.style.visibility = petSleeping ? 'visible' : 'hidden';

    // waddle left-right (pausado si duerme)
    if (!petSleeping) {
      petWalkX += petDir * 1.2;
      if (petWalkX > 18)  petDir = -1;
      if (petWalkX < -12) petDir =  1;
    }

    // decay mood
    if (petMood > 0) petMood = Math.max(0, petMood - 0.035);

    drawBug(petLevel, petFrame, petMood);
  }
  requestAnimationFrame(tickBug);
}
requestAnimationFrame(tickBug);

function updatePetLabel() {
  document.getElementById('petLvLabel').textContent = `lv.${petLevel}`;
}
updatePetLabel();

function recordActivity() {
  lastActivityTime = Date.now();
}
document.addEventListener('mousemove', recordActivity);
document.addEventListener('keydown', recordActivity);
document.addEventListener('click', recordActivity);
document.addEventListener('paste', recordActivity);

function growPet(msg) {
  petMood = 1.0;
  if (petLevel < 10) petLevel++;
  updatePetLabel();
  savePetState(petLevel, getTodayDate());

  const pop = document.createElement('div');
  pop.className = 'grow-pop';
  pop.textContent = msg || '+1 nivel ‚ú¶';
  document.body.appendChild(pop);
  setTimeout(() => pop.remove(), 1500);
}

function getTodayDate() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

// Sube de nivel solo cuando se comparte archivo/c√≥digo y como m√°ximo 1 vez por d√≠a
function tryGrowPetFromShare() {
  if (petLevel >= 10) return;
  const today = getTodayDate();
  if (petState.lastLevelUpDate === today) return;
  petState.lastLevelUpDate = today;
  growPet('‚ú¶ compartiste ‚Üí +1 nivel');
}

// ========== SYNTAX DETECTION ==========
function detectSyntax(text) {
  text = text.trim();
  if (/\b(SELECT|INSERT|UPDATE|DELETE|CREATE TABLE|ALTER|DROP|FROM|WHERE|JOIN|GROUP BY|ORDER BY)\b/i.test(text))
    return { lang:'sql',  ext:'sql',  label:'SQL' };
  if (/<[A-Z][A-Za-z]*[\s/>]/.test(text) || /import React|from ['"]react['"]|useState|useEffect/.test(text))
    return { lang:'jsx',  ext:'jsx',  label:'JSX' };
  try { if (text.startsWith('{') || text.startsWith('[')) { JSON.parse(text); return { lang:'json', ext:'json', label:'JSON' }; } } catch(e) {}
  if (/\bdef \w+\(|import \w+|from \w+ import|\bclass \w+:|print\(/.test(text))
    return { lang:'py',   ext:'py',   label:'Python' };
  if (/[.#][\w-]+\s*\{|@media|@keyframes|:root/.test(text))
    return { lang:'css',  ext:'css',  label:'CSS' };
  if (/\bconst\b|\blet\b|\bvar\b|\bfunction\b|\bexport\b|\bimport\b|\b=>\b/.test(text))
    return { lang:'js',   ext:'js',   label:'JavaScript' };
  return { lang:'txt', ext:'txt', label:'Texto' };
}

function generateFilename(lang) {
  const adj = ['veloz','nuevo','temporal','draft','beta','rapido'][Math.floor(Math.random()*6)];
  return `un_coso_${adj}.${lang.ext}`;
}
switchSpace(currentSpace);

// ========== COLOR POR LENGUAJE DOMINANTE ==========
const LANG_ACCENT = {
  sql: '#4488ff', jsx: '#00ff88', js: '#ffdc00', json: '#ff9632',
  py: '#64b4ff', css: '#c864ff', txt: '#555570', file: '#ff4466'
};
function getDominantLanguage() {
  const count = {};
  Object.keys(cards).forEach(id => {
    if (cards[id].space !== currentSpace) return;
    const lang = cards[id].type === 'file' ? 'file' : (cards[id].meta?.detected?.lang || 'txt');
    count[lang] = (count[lang] || 0) + 1;
  });
  let max = 0, dominant = null;
  Object.keys(count).forEach(lang => {
    if (count[lang] > max) { max = count[lang]; dominant = lang; }
  });
  return dominant;
}
function updateAccentFromBoard() {
  const lang = getDominantLanguage();
  const color = lang ? (LANG_ACCENT[lang] || '#00ff88') : '#00ff88';
  document.documentElement.style.setProperty('--accent', color);
}

// ========== CARDS ==========
let cardCounter = 0;
const cards = {};
const PAD = 16;
const CARDS_STORAGE_KEY = 'pz_cards_' + SESSION_ID;
const MAX_STORED_FILE_SIZE = 800 * 1024; // 800KB por archivo para no llenar localStorage
const CELL_W = 280;
const CELL_H = 300;
const CARD_GAP = 12;

function getViewportSize() {
  return {
    vw: Math.max(200, window.innerWidth - 56),
    vh: Math.max(200, window.innerHeight - 52)
  };
}

function getUsedGridCells() {
  const inner = document.getElementById('canvasInner');
  const used = new Set();
  const { vw } = getViewportSize();
  const maxCol = Math.max(1, Math.floor((vw - PAD * 2) / CELL_W));
  inner.querySelectorAll('.card').forEach(el => {
    if (el.dataset.space !== currentSpace) return;
    const l = parseInt(el.style.left, 10) || 0;
    const t = parseInt(el.style.top, 10) || 0;
    const col = Math.round((l - PAD) / CELL_W);
    const row = Math.round((t - PAD) / CELL_H);
    used.add(row + ',' + col);
  });
  return used;
}

function getNextGridPosition() {
  const { vw, vh } = getViewportSize();
  const maxCol = Math.max(1, Math.floor((vw - PAD * 2) / CELL_W));
  const maxRow = Math.max(1, Math.floor((vh - PAD * 2) / CELL_H));
  const used = getUsedGridCells();
  for (let row = 0; row < maxRow; row++) {
    for (let col = 0; col < maxCol; col++) {
      if (!used.has(row + ',' + col)) {
        const x = PAD + col * CELL_W + (Math.random() * 12 - 6);
        const y = PAD + row * CELL_H + (Math.random() * 12 - 6);
        return { x, y };
      }
    }
  }
  const x = PAD + (Math.random() * Math.max(0, vw - 320));
  const y = PAD + (Math.random() * Math.max(0, vh - 200));
  return { x, y };
}

function saveCardsToStorage() {
  try {
    const list = [];
    Object.keys(cards).forEach(id => {
      const c = cards[id];
      const el = document.getElementById(id);
      const left = el ? (parseInt(el.style.left, 10) || 0) : 0;
      const top = el ? (parseInt(el.style.top, 10) || 0) : 0;
      let content = c.content;
      if (c.type === 'file' && typeof content === 'string' && content.length > MAX_STORED_FILE_SIZE)
        content = null;
      list.push({ id, content, type: c.type, meta: c.meta, left, top });
    });
    localStorage.setItem(CARDS_STORAGE_KEY, JSON.stringify(list));
  } catch (e) {
    if (e.name === 'QuotaExceededError') {
      try {
        const list = [];
        Object.keys(cards).forEach(id => {
          const c = cards[id];
          if (c.type !== 'code') return;
          const el = document.getElementById(id);
          const left = el ? (parseInt(el.style.left, 10) || 0) : 0;
          const top = el ? (parseInt(el.style.top, 10) || 0) : 0;
          list.push({ id, content: c.content, type: c.type, meta: c.meta, left, top });
        });
        localStorage.setItem(CARDS_STORAGE_KEY, JSON.stringify(list));
      } catch (e2) {}
    }
  }
}

function loadCardsFromStorage() {
  try {
    const raw = localStorage.getItem(CARDS_STORAGE_KEY);
    if (!raw) return false;
    const list = JSON.parse(raw);
    if (!Array.isArray(list) || list.length === 0) return false;
    const inner = document.getElementById('canvasInner');
    list.forEach(item => {
      const id = item.id;
      const num = parseInt(id.replace('card-', ''), 10);
      if (num > cardCounter) cardCounter = num;
      cards[id] = { content: item.content, type: item.type, meta: item.meta || {} };
      const meta = cards[id].meta;
      meta.space = meta.space || 'general';
      const left = (item.left != null ? item.left : PAD) + 'px';
      const top = (item.top != null ? item.top : PAD) + 'px';
      const userNameEsc = esc(meta.userName || 'An√≥nimo');
      const createdAt = (meta.createdAt != null) ? meta.createdAt : new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
      let header = '', body = '', footer = '';
      if (item.type === 'code') {
        const det = meta.detected || { lang: 'txt', label: 'Texto' };
        header = '<span class="card-lang lang-' + det.lang + '">' + det.label + '</span><span class="card-filename">' + esc(meta.filename || '') + '</span><div class="card-actions"><button class="card-btn" onclick="copyCard(\'' + id + '\')" title="Copiar">‚ßâ</button><button class="card-btn danger" onclick="removeCard(\'' + id + '\')" title="Eliminar">‚úï</button></div>';
        body = '<pre>' + (item.content ? highlightCode(item.content, det.lang) : esc('')) + '</pre>';
        footer = '<span class="card-time">Por ' + userNameEsc + ' ¬∑ ' + createdAt + '</span><button class="card-download" onclick="downloadCard(\'' + id + '\')">‚Üì descargar</button>';
      } else {
        const fnEsc = esc(meta.name || 'archivo');
        header = '<span class="card-lang lang-file">ARCHIVO</span><span class="card-filename">' + fnEsc + '</span><div class="card-actions"><button class="card-btn" onclick="copyFileCard(\'' + id + '\')" title="Copiar nombre">‚ßâ</button><button class="card-btn danger" onclick="removeCard(\'' + id + '\')" title="Eliminar">‚úï</button></div>';
        body = '<div style="text-align:center;padding:8px 0"><span class="file-icon">' + getFileIcon(meta.ext) + '</span><div class="file-meta">' + fnEsc + '<br>' + formatSize(meta.size || 0) + ' ¬∑ .' + (meta.ext || '').toUpperCase() + '</div></div>';
        footer = '<span class="card-time">Por ' + userNameEsc + ' ¬∑ ' + createdAt + '</span><button class="card-download" onclick="downloadFileCard(\'' + id + '\')">‚Üì descargar</button>';
      }
      const div = document.createElement('div');
      div.className = 'card';
      div.id = id;
      div.dataset.space = meta.space;
      div.style.left = left;
      div.style.top = top;
      div.style.display = meta.space === currentSpace ? '' : 'none';
      div.innerHTML = '<div class="card-header">' + header + '</div><div class="card-body">' + body + '</div><div class="card-footer">' + footer + '</div>';
      inner.appendChild(div);
      makeDraggable(div);
    });
    updateSpaceBadges();
    updateAccentFromBoard();
    return true;
  } catch (e) {
    return false;
  }
}

function organizeCardsInGrid() {
  const inner = document.getElementById('canvasInner');
  const cardEls = [...inner.querySelectorAll('.card')].filter(el => el.dataset.space === currentSpace);
  if (!cardEls.length) { showToast('No hay tarjetas que organizar'); return; }
  const { vw, vh } = getViewportSize();
  const byUser = {};
  cardEls.forEach(el => {
    const data = cards[el.id];
    const user = (data && data.meta && data.meta.userName) ? data.meta.userName : 'An√≥nimo';
    if (!byUser[user]) byUser[user] = [];
    byUser[user].push(el);
  });
  const users = Object.keys(byUser).sort();
  const numCols = Math.max(1, users.length);
  const colWidth = (vw - PAD * 2 - CARD_GAP * (numCols - 1)) / numCols;
  let maxBottom = 0;
  users.forEach((user, colIndex) => {
    const list = byUser[user];
    const x = PAD + colIndex * (colWidth + CARD_GAP);
    list.forEach((el, rowIndex) => {
      const y = PAD + rowIndex * (CELL_H + CARD_GAP);
      el.style.left = x + 'px';
      el.style.top = y + 'px';
      el.style.maxWidth = Math.max(200, colWidth) + 'px';
      maxBottom = Math.max(maxBottom, y + CELL_H);
    });
  });
  inner.style.minHeight = Math.max(vh, maxBottom + PAD * 2) + 'px';
  showToast('Tarjetas organizadas por usuario');
}

function createCard(content, type, meta = {}) {
  const id = 'card-' + (++cardCounter);
  const inner = document.getElementById('canvasInner');
  const { x, y } = getNextGridPosition();

  const userName = meta.userName !== undefined ? meta.userName : getOrPromptUsername();
  meta.userName = userName;
  meta.space = meta.space || currentSpace;
  const userNameEsc = esc(userName);
  const spaceName = SPACES[meta.space] || 'General';

  const div = document.createElement('div');
  div.className = 'card';
  div.id = id;
  div.dataset.space = meta.space;
  div.style.left = x+'px';
  div.style.top  = y+'px';
  div.style.display = meta.space === currentSpace ? '' : 'none';

  const createdAt = new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
  meta.createdAt = createdAt;
  let header='', body='', footer='';

  if (type === 'code') {
    const {detected, filename} = meta;
    header = `
      <span class="card-lang lang-${detected.lang}">${detected.label}</span>
      <span class="card-filename">${esc(filename)}</span>
      <div class="card-actions">
        <button class="card-btn" onclick="copyCard('${id}')" title="Copiar">‚ßâ</button>
        <button class="card-btn danger" onclick="removeCard('${id}')" title="Eliminar">‚úï</button>
      </div>`;
    body = `<pre>${highlightCode(content, detected.lang)}</pre>`;
    footer = `
      <span class="card-time">Por ${userNameEsc} ¬∑ ${createdAt}</span>
      <button class="card-download" onclick="downloadCard('${id}')">‚Üì descargar</button>`;
  } else {
    const icon = getFileIcon(meta.ext);
    const fnEsc = esc(meta.name);
    header = `
      <span class="card-lang lang-file">ARCHIVO</span>
      <span class="card-filename">${fnEsc}</span>
      <div class="card-actions">
        <button class="card-btn" onclick="copyFileCard('${id}')" title="Copiar nombre">‚ßâ</button>
        <button class="card-btn danger" onclick="removeCard('${id}')" title="Eliminar">‚úï</button>
      </div>`;
    body = `
      <div style="text-align:center;padding:8px 0">
        <span class="file-icon">${icon}</span>
        <div class="file-meta">${fnEsc}<br>${formatSize(meta.size)} ¬∑ .${(meta.ext||'').toUpperCase()}</div>
      </div>`;
    footer = `
      <span class="card-time">Por ${userNameEsc} ¬∑ ${createdAt}</span>
      <button class="card-download" onclick="downloadFileCard('${id}')">‚Üì descargar</button>`;
  }

  div.innerHTML = `
    <div class="card-header">${header}</div>
    <div class="card-body">${body}</div>
    <div class="card-footer">${footer}</div>`;

  inner.appendChild(div);
  makeDraggable(div);
  cards[id] = {content, type, meta};
  div.classList.add('card-pulse');
  setTimeout(() => div.classList.remove('card-pulse'), 2200);
  updateSpaceBadges();
  updateAccentFromBoard();
  saveCardsToStorage();
  showToast(userName + ' agreg√≥ en ' + spaceName);
  return id;
}

function highlightCode(code, lang) {
  let h = esc(code);
  if (lang==='sql') {
    h = h.replace(/\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|OUTER|ON|AS|INSERT INTO|VALUES|UPDATE|SET|DELETE|CREATE TABLE|ALTER TABLE|DROP|ADD|COLUMN|PRIMARY KEY|FOREIGN KEY|REFERENCES|NOT NULL|NULL|UNIQUE|DEFAULT|INDEX|GROUP BY|ORDER BY|HAVING|LIMIT|OFFSET|DISTINCT|COUNT|SUM|AVG|MAX|MIN)\b/gi,'<span class="kw">$1</span>');
    h = h.replace(/(['"])(.*?)\1/g,'<span class="str">$1$2$1</span>');
    h = h.replace(/--.*$/gm,'<span class="cmt">$&</span>');
    h = h.replace(/\b\d+\b/g,'<span class="num">$&</span>');
  } else if (lang==='jsx'||lang==='js') {
    h = h.replace(/\b(const|let|var|function|return|import|export|default|from|if|else|for|while|class|extends|new|this|async|await|try|catch|typeof|null|undefined|true|false)\b/g,'<span class="kw">$1</span>');
    h = h.replace(/(['"`])(.*?)\1/g,'<span class="str">$1$2$1</span>');
    h = h.replace(/\/\/.*/g,'<span class="cmt">$&</span>');
    h = h.replace(/\b\d+\b/g,'<span class="num">$&</span>');
  } else if (lang==='py') {
    h = h.replace(/\b(def|class|import|from|return|if|elif|else|for|while|in|not|and|or|True|False|None|with|as|try|except|finally|pass|break|continue|raise|lambda)\b/g,'<span class="kw">$1</span>');
    h = h.replace(/(['"])(.*?)\1/g,'<span class="str">$1$2$1</span>');
    h = h.replace(/#.*/g,'<span class="cmt">$&</span>');
    h = h.replace(/\b\d+\b/g,'<span class="num">$&</span>');
  }
  return h;
}

function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function getFileIcon(ext) {
  return {pdf:'üìÑ',png:'üñºÔ∏è',jpg:'üñºÔ∏è',jpeg:'üñºÔ∏è',mp4:'üé¨',mp3:'üéµ',zip:'üì¶',rar:'üì¶',xls:'üìä',xlsx:'üìä',doc:'üìù',docx:'üìù',csv:'üìã',gif:'üéûÔ∏è',svg:'üñåÔ∏è',psd:'üé®'}[ext.toLowerCase()]||'üìÅ';
}
function formatSize(b) {
  if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';
}

function removeCard(id) {
  const el = document.getElementById(id);
  if (el) { el.style.transition='all 0.2s'; el.style.transform='scale(0.8)'; el.style.opacity='0'; setTimeout(()=>{ el.remove(); updateSpaceBadges(); updateAccentFromBoard(); saveCardsToStorage(); },200); delete cards[id]; }
}
function copyCard(id) {
  const c = cards[id];
  if (!c || !c.content) return;
  const text = c.content;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => showToast('‚úì Copiado')).catch(() => copyFallback(text));
  } else {
    copyFallback(text);
  }
}
function copyFallback(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed'; ta.style.left = '-9999px';
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand('copy');
    showToast('‚úì Copiado');
  } catch (e) {
    showToast('No se pudo copiar');
  }
  document.body.removeChild(ta);
}
function downloadCard(id) {
  const c = cards[id];
  if (!c || c.type !== 'code') return;
  const fn = c.meta.filename || 'codigo.txt';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([c.content], { type: 'text/plain' }));
  a.download = fn;
  a.click();
  URL.revokeObjectURL(a.href);
  triggerCelebration();
  showToast('‚Üì ' + fn);
}
function copyFileCard(id) {
  const c = cards[id];
  if (!c || c.type !== 'file') return;
  const text = c.meta.name || '';
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => showToast('‚úì Nombre copiado')).catch(() => copyFallback(text));
  } else {
    copyFallback(text);
  }
}
function downloadFileCard(id) {
  const c = cards[id];
  if (!c || c.type !== 'file' || !c.content) return;
  const fn = c.meta.name || 'archivo';
  const a = document.createElement('a');
  a.href = c.content;
  a.download = fn;
  a.click();
  triggerCelebration();
  showToast('‚Üì ' + fn);
}
function clearAll() {
  clearedCardsBuffer[currentSpace] = [];
  const buf = clearedCardsBuffer[currentSpace];
  Object.keys(cards).forEach(id => {
    if (cards[id].space !== currentSpace) return;
    const el = document.getElementById(id);
    if (el) {
      buf.push({ id, el, data: { ...cards[id] } });
      el.remove();
    }
    delete cards[id];
  });
  updateSpaceBadges();
  updateRestoreButtonVisibility();
  updateAccentFromBoard();
  saveCardsToStorage();
  if (buf.length > 0)
    showToastWithUndo('üóë Pizarr√≥n de ' + SPACES[currentSpace] + ' limpiado', restoreCleared);
  else
    showToast('No hay tarjetas en este pizarr√≥n');
}

function restoreCleared() {
  const buf = clearedCardsBuffer[currentSpace] || [];
  if (!buf.length) return;
  const inner = document.getElementById('canvasInner');
  buf.forEach(({ id, el, data }) => {
    inner.appendChild(el);
    cards[id] = data;
  });
  clearedCardsBuffer[currentSpace] = [];
  refreshSpaceVisibility();
  updateSpaceBadges();
  updateAccentFromBoard();
  updateRestoreButtonVisibility();
  saveCardsToStorage();
  showToast('‚Ü© Restaurado');
}

// ========== DRAG ==========
function makeDraggable(el) {
  let sx,sy,ox,oy;
  el.addEventListener('mousedown',(e)=>{
    if(e.target.tagName==='BUTTON')return;
    el.classList.add('dragging');sx=e.clientX;sy=e.clientY;ox=parseInt(el.style.left);oy=parseInt(el.style.top);
    const mv=(e)=>{el.style.left=(ox+e.clientX-sx)+'px';el.style.top=(oy+e.clientY-sy)+'px';};
    const up=()=>{el.classList.remove('dragging');document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
    document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
  });
}

// ========== FILE DROP Y EXPLORADOR ==========
const canvasEl = document.getElementById('canvas');
const dropOv   = document.getElementById('dropOverlay');
const textExts = ['sql','jsx','js','ts','tsx','py','css','html','json','txt','md','xml','yaml','yml','sh','rb','go','rs','php','c','cpp','java'];

function addFileToBoard(file) {
  const ext = file.name.split('.').pop().toLowerCase();
  if (textExts.includes(ext)) {
    const r = new FileReader();
    r.onload = ev => {
      const content = ev.target.result;
      const detected = (['sql','jsx','js','ts','tsx','py','css','json'].includes(ext))
        ? { lang: ext === 'ts' || ext === 'tsx' ? 'jsx' : ext, ext, label: ext.toUpperCase() }
        : detectSyntax(content);
      createCard(content, 'code', { detected, filename: file.name });
      tryGrowPetFromShare();
      showToast('‚úì ' + file.name);
    };
    r.readAsText(file);
  } else {
    const fr = new FileReader();
    fr.onload = ev => {
      createCard(ev.target.result, 'file', { name: file.name, ext, size: file.size });
      tryGrowPetFromShare();
      showToast('üìÅ ' + file.name);
    };
    fr.readAsDataURL(file);
  }
}

canvasEl.addEventListener('dragover', e=>{e.preventDefault();dropOv.classList.add('active');});
canvasEl.addEventListener('dragleave',()=>dropOv.classList.remove('active'));
canvasEl.addEventListener('drop',e=>{
  e.preventDefault();dropOv.classList.remove('active');
  [...e.dataTransfer.files].forEach(file => addFileToBoard(file));
});

function openFilePicker() {
  document.getElementById('fileInput').click();
}
document.getElementById('fileInput').addEventListener('change', function() {
  const files = this.files;
  if (!files || !files.length) return;
  const n = files.length;
  for (let i = 0; i < n; i++) addFileToBoard(files[i]);
  if (n > 1) showToast(`${n} archivos agregados al pizarr√≥n`);
  this.value = '';
});

// ========== PASTE ==========
document.addEventListener('paste', function(e) {
  try {
    const dt = e.clipboardData;
    if (!dt) return;
    const items = dt.items;
    if (items) {
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        if (item.kind === 'file' && item.type.indexOf('image/') === 0) {
          const file = item.getAsFile();
          if (file) {
            e.preventDefault();
            const fr = new FileReader();
            fr.onload = function(ev) {
              createCard(ev.target.result, 'file', { name: file.name || 'imagen.png', ext: (file.name||'').split('.').pop()||'png', size: file.size });
              tryGrowPetFromShare();
              saveCardsToStorage();
              showToast('üìÅ Imagen pegada');
            };
            fr.readAsDataURL(file);
            return;
          }
        }
      }
    }
    const text = dt.getData('text/plain') || dt.getData('text') || '';
    if (text.trim()) {
      e.preventDefault();
      lastActivityTime = Date.now();
      petJump = 18;
      const detected = detectSyntax(text);
      const filename = generateFilename(detected);
      createCard(text, 'code', { detected, filename });
      tryGrowPetFromShare();
      saveCardsToStorage();
      showToast('‚úì ' + detected.label + ' ‚Üí ' + filename);
    }
  } catch (err) {
    console.warn('Paste error:', err);
    showToast('No se pudo pegar. Prueba el bot√≥n + o arrastrar.');
  }
});

// ========== TEXT INPUT ==========
function openTextInput() {
  const text=prompt('Pega tu c√≥digo aqu√≠:');
  if(text&&text.trim()){
    const detected=detectSyntax(text);
    const filename=generateFilename(detected);
    createCard(text,'code',{detected,filename});
    tryGrowPetFromShare();
    showToast(`‚úì ${detected.label} ‚Üí ${filename}`);
  }
}

// ========== MANUAL / AYUDA ==========
function openManual() {
  const name = (localStorage.getItem(USERNAME_KEY) || 'Usuario').trim() || 'Usuario';
  const el = document.getElementById('manualUserName');
  if (el) el.textContent = name;
  document.getElementById('manualOverlay').classList.add('open');
  recordActivity();
}
function closeManual() {
  document.getElementById('manualOverlay').classList.remove('open');
}
function closeManualIfBackdrop(e) {
  if (e.target.id === 'manualOverlay') closeManual();
}

// ========== SHARE (permanent link) ==========
function shareSession() {
  const url = (location.origin || '') + (location.pathname || '/') + '?session=' + SESSION_ID;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(url).then(() => showToast('üîó Link copiado ‚Äî el enlace NO expira')).catch(() => copyFallback(url));
  } else {
    copyFallback(url);
    showToast('üîó Link copiado');
  }
}

// ========== TOAST ==========
function triggerCelebration() {
  const colors = ['#00ff88', '#ff4466', '#4488ff', '#ffdc00', '#ff9632', '#c864ff', '#64b4ff'];
  const count = 28;
  for (let i = 0; i < count; i++) {
    const el = document.createElement('div');
    el.className = 'celebration-confetti';
    const angle = (i / count) * Math.PI * 2 + Math.random() * 0.5;
    const dist = 80 + Math.random() * 100;
    el.style.setProperty('--dx', Math.cos(angle) * dist + 'px');
    el.style.setProperty('--dy', -60 - Math.random() * 80 + 'px');
    el.style.background = colors[i % colors.length];
    el.style.animationDelay = (i * 0.02) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1400);
  }
}

function showToast(msg, dur=3000) {
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.innerHTML='';
  t.appendChild(document.createTextNode(msg));
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}
function showToastWithUndo(msg, onUndo, dur=6000) {
  const t=document.getElementById('toast');
  t.innerHTML='';
  t.appendChild(document.createTextNode(msg + ' '));
  const btn=document.createElement('button');
  btn.className='btn';
  btn.style.cssText='padding:4px 10px;font-size:11px;margin-left:8px;';
  btn.textContent='Deshacer';
  btn.onclick=()=>{ t.classList.remove('show'); onUndo(); };
  t.appendChild(btn);
  t.classList.add('show');
  setTimeout(()=>{ t.classList.remove('show'); t.innerHTML=''; }, dur);
}

// ========== ON JOIN ==========
if (session.isJoining) {
  setTimeout(()=>{
    showToast(`‚úì Conectado a ${SESSION_ID}`);
    updateUserCount();
  }, 600);
}

// ========== CARGAR GUARDADO O DEMO ==========
if (!loadCardsFromStorage()) {
  setTimeout(()=>{
    createCard(
      `SELECT u.id, u.name, COUNT(o.id) AS total_orders\nFROM users u\nLEFT JOIN orders o ON o.user_id = u.id\nWHERE u.active = 1\nGROUP BY u.id\nORDER BY total_orders DESC\nLIMIT 10;`,
      'code', {detected:{lang:'sql',ext:'sql',label:'SQL'}, filename:'un_coso_veloz.sql', userName:'Pizarr√≥n'});
  }, 400);
  setTimeout(()=>{
    createCard(
      `import { useState } from 'react'\n\nexport default function Card({ title, body }) {\n  const [open, setOpen] = useState(false)\n\n  return (\n    <div className="card">\n      <h2 onClick={() => setOpen(!open)}>{title}</h2>\n      {open && <p>{body}</p>}\n    </div>\n  )\n}`,
      'code', {detected:{lang:'jsx',ext:'jsx',label:'JSX'}, filename:'un_coso_nuevo.jsx', userName:'Pizarr√≥n'});
  }, 750);
  setTimeout(()=>{
    createCard('', 'file', {name:'dise√±o_final_v3.figma', ext:'figma', size:2_400_000, userName:'Pizarr√≥n'});
  }, 1100);
}
setTimeout(updateAccentFromBoard, 1200);
</script>
</body>
</html>
